# NixOS Flake Configuration


A vibe-coded modular NixOS configuration:

* **Flakes** for reproducibility.
* **Home Manager** for user environment management.
* **Modular Design** to share config between machines.

## ğŸ“‚ Structure

```text
~/nix-config/
â”œâ”€â”€ flake.nix             # Entry point: defines inputs & machine outputs
â”œâ”€â”€ flake.lock            # Pinned versions (source of truth)
â”œâ”€â”€ modules/              # Reusable logic
â”‚   â”œâ”€â”€ nixos/            # System-level modules
â”‚   â”‚   â”œâ”€â”€ hardware/     # Drivers (Nvidia, OpenRGB)
â”‚   â”‚   â”œâ”€â”€ desktop/      # System-level DEs (Niri, Gnome)
â”‚   â”‚   â””â”€â”€ services/     # System features (Steam, Stylix)
â”‚   â””â”€â”€ home-manager/     # User environment
â”‚       â”œâ”€â”€ features/     # Atomic tool configs (cli/gui)
â”‚       â””â”€â”€ profiles/     # Composable bundles (Core, Dev, Desktop)
â””â”€â”€ hosts/                # Machine-specific configurations
    â””â”€â”€ nixdt/            # Hostname: nixdt
        â”œâ”€â”€ default.nix   # System entry point
        â”œâ”€â”€ home.nix      # User entry point (Imports HM profiles)
        â””â”€â”€ hardware-configuration.nix # Autogenerated hardware info
```

## âš¡ Cheatsheet

**Check Build (No Sudo):**

```bash
# Check for build errors without creating the 'result' symlink
nixos-rebuild build --flake .#nixdt --no-link
```

**Apply Changes (System & Home):**

```bash
git add .
sudo nixos-rebuild switch --flake .#nixdt
```

**Apply Changes (Home Only - Faster):**

```bash
home-manager switch --flake .
```

**Clean Garbage (Free disk space):**

```bash
# Delete older generations
sudo nix-collect-garbage -d

```

---

## ğŸ”„ Updates & Maintenance

### How to Update

Updates are manual and explicit. Nothing changes until you run these commands.

1. **Update the Lockfile** (Downloads latest package versions):
```bash
nix flake update

```


2. **Apply the Update**:
```bash
sudo nixos-rebuild switch --flake .#nixdt

```


3. **Commit the State**:
```bash
git commit -am "chore: update system inputs"

```



### ğŸš‘ Recovering from Breakage

If an update breaks your WiFi, Graphics, or Config:

**Option A: Rollback via CLI** (If you can still use the terminal)

```bash
sudo nixos-rebuild switch --rollback

```

**Option B: Rollback via Boot Menu** (If the system won't boot)

1. Reboot the computer.
2. In the systemd-boot menu, select the entry below the current one (e.g., `NixOS - Generation 44`).
3. The system will boot into the exact state it was in before the update.

---

## ğŸ›  Workflows

### 1. How to Add Packages

*   **Quick User Tools**: Add to `home.packages` in `hosts/<host>/home.nix`.
*   **Persistent Features**: Create a new file in `modules/home-manager/features/` and import it into a Profile.
*   **System Drivers/Services**: Add to `modules/nixos/services/` or `hardware/`.
*   **Unfree Support**: Ensure `nixpkgs.config.allowUnfree = true` is set in the host's `home.nix` or system `base.nix`.

### 2. How to Add a New Machine

1. **Copy Host:** `cp -r hosts/nixdt hosts/new-machine`
2. **Hardware Scan:** `nixos-generate-config --show-hardware-config > hosts/new-machine/hardware-configuration.nix`
3. **Flake Registry:** Add `new-machine` to `flake.nix` outputs.
4. **Build:** `sudo nixos-rebuild switch --flake .#new-machine`

### 3. Proprietary Apps (Antigravity/Jetski)

If an app isn't in Nixpkgs or fails to build:

* **Option A:** Use **Flatpak** (`flatpak install ...`).
* **Option B:** Use **Steam-Run** (`steam-run ./my-binary`).

---

## âš ï¸ Important Gotchas

**1. "Path does not exist" Error**
Nix Flakes only see files that are **tracked by git**.

```bash
git add .

```

**2. Permission Denied**

* Use `sudo` for `nixos-rebuild`.
* Do **NOT** use `sudo` for `git` commands.

**3. Home Manager & Unfree Packages**
If Home Manager complains about unfree packages, ensure `useGlobalPkgs = true;` is set in the host's `default.nix`.

**4. Home Manager & Nixpkgs Overrides**
When `useGlobalPkgs = true` is enabled, Home Manager **cannot** modify `nixpkgs` (e.g., `nixpkgs.overlays` or `nixpkgs.config.allowUnfree`). All such overrides must be done in a **NixOS module** (e.g., `modules/nixos/hardware/nvidia.nix`) instead of in `home.nix`.
